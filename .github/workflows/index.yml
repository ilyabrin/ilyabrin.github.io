name: Index Posts to README

on:
  push:
    branches:
      - master
    paths:
      - "content/post/**/*.md"
      - ".github/workflows/index.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  index-posts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Index posts and update README
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const SITE_URL = 'https://ilyabrin.github.io';
          const POSTS_DIR = 'content/post';

          function extractFrontmatter(content) {
            const match = content.match(/^---\n([\s\S]*?)\n---/);
            return match ? match[1] : null;
          }

          function parseField(frontmatter, field, isQuoted = false) {
            const pattern = isQuoted 
              ? new RegExp(`${field}:\\s*["'](.+?)["']`)
              : new RegExp(`${field}:\\s*(.+)`);
            const match = frontmatter.match(pattern);
            return match ? match[1] : null;
          }

          function processPost(file) {
            const filePath = path.join(POSTS_DIR, file);
            const content = fs.readFileSync(filePath, 'utf-8');
            
            const frontmatter = extractFrontmatter(content);
            if (!frontmatter) return null;
            
            const isDraft = parseField(frontmatter, 'draft') === 'true';
            if (isDraft) return null;
            
            const title = parseField(frontmatter, 'title', true);
            const date = parseField(frontmatter, 'date');
            
            if (!title || !date) return null;
            
            const langMatch = file.match(/\.(ru|en)\.md$/);
            const lang = langMatch ? langMatch[1].toUpperCase() : 'EN';
            const baseName = file.replace(/\.(ru|en)\.md$/, '');
            
            return {
              baseName,
              title,
              date: date.split('T')[0],
              lang
            };
          }

          function generateReadme(posts) {
            let content = '# Blog Posts Index\n\n## Published Posts\n\n';
            
            posts.forEach(post => {
              const langs = Array.from(post.langs).sort().map(l => {
                const url = `${SITE_URL}/${l.toLowerCase()}/post/${post.slug}/`;
                return `[[${l}]](${url})`;
              }).join(' ');
              content += `- **${post.date}** - ${post.title} ${langs}\n`;
            });

            content += `\n---\n*Last updated: ${new Date().toISOString().split('T')[0]}*  \n`;
            content += `*Total posts: ${posts.length}*\n`;
            
            return content;
          }

          // Main logic
          const files = fs.readdirSync(POSTS_DIR).filter(f => f.endsWith('.md'));
          const postsMap = new Map();

          files.forEach(file => {
            const post = processPost(file);
            if (!post) return;

            if (!postsMap.has(post.baseName)) {
              postsMap.set(post.baseName, {
                title: post.title,
                date: post.date,
                slug: post.baseName,
                langs: new Set()
              });
            }
            postsMap.get(post.baseName).langs.add(post.lang);
          });

          const posts = Array.from(postsMap.values())
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          const readmeContent = generateReadme(posts);
          fs.writeFileSync('README.md', readmeContent, 'utf-8');

          console.log(`‚úÖ Indexed ${posts.length} posts to README.md`);
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìù Auto-update README with posts index" && git push)
